{% extends "rgz/rgz_base.html" %}

{% block lab %}РГЗ. Камера хранения{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='rgz/rgz.css') }}">
{% endblock %}

{% block script %}
<script>
    function jsonRpc(method, params) {
        const url = '/rgz/json-rpc-api';
        const json = {
            'jsonrpc': '2.0',
            'method': method,
            'params': params,
            'id': Math.round(Math.random() * 100000)
        };
        return fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(json)
        }).then(r => r.json());
    }

    function loadState() {
        jsonRpc('info', null).then(data => {
            if (data.error) {
                alert("Ошибка: " + data.error.message);
                return;
            }

            const st = data.result;
            const lockers = st.lockers;
            const user = st.user;

            document.getElementById('total').innerText = st.total;
            document.getElementById('occupied').innerText = st.occupied;
            document.getElementById('free').innerText = st.free;
            document.getElementById('mycount').innerText = st.my_count;

            if (user) {
                document.getElementById("guest-panel").style.display = "none";
                document.getElementById("user-panel").style.display = "block";
                document.getElementById('user-info').innerText =
                    "Вы вошли как: " + user.login + (user.is_admin ? " (администратор)" : "");

                if (user.is_admin) {
                    document.getElementById("user-limit-info").style.display = "none";
                } else {
                    document.getElementById("user-limit-info").style.display = "block";
                }

            } else {
                document.getElementById("guest-panel").style.display = "block";
                document.getElementById("user-panel").style.display = "none";
                document.getElementById('user-info').innerText = "Вы не авторизованы.";
                document.getElementById("user-limit-info").style.display = "none";
            }

            const grid = document.getElementById('locker-grid');
            grid.innerHTML = '';

            lockers.forEach(l => {
                const div = document.createElement('div');
                div.className = 'cell';

                if (!l.free) {
                    if (l.mine) div.classList.add('mine');
                    else div.classList.add('occupied');
                }

                if (l.free) div.title = "Свободно";
                else if (l.mine) div.title = "Занято вами";
                else div.title = "Занято пользователем: " + l.owner;

                div.onclick = function () {

                    if (!user) {
                        if (l.free) {
                            alert("Ячейка свободна, для бронирования войдите в аккаунт");
                        } else {
                            alert("Эта ячейка занята пользователем: " + l.owner);
                        }
                        return;
                    }

                    if (l.free) {
                        if (user.is_admin) {
                            alert("Администратор не может бронировать ячейки");
                            return;
                        }
                        booking(l.id);
                        return;
                    }

                    if (l.mine) {
                        cancellation(l.id);
                        return;
                    }

                    if (user.is_admin) {
                        if (confirm("Освободить ячейку, занятую пользователем: " + l.owner + "?")) {
                            cancellation(l.id);
                        }
                    } else {
                        alert("Эта ячейка занята пользователем: " + l.owner);
                    }
                };

                grid.appendChild(div);
            });
        });
    }

    function booking(id) {
        jsonRpc('booking', id).then(data => {
            if (data.error) alert(data.error.message);
            loadState();
        });
    }

    function cancellation(id) {
        jsonRpc('cancellation', id).then(data => {
            if (data.error) alert(data.error.message);
            loadState();
        });
    }

    document.addEventListener('DOMContentLoaded', loadState);
</script>
{% endblock %}

{% block main %}

<h1>Камера хранения</h1>

<p id="user-info"></p>

<div id="guest-panel">
    <a href="/rgz/login">Вход</a>
    <a href="/rgz/register">Регистрация</a>
</div>

<div id="user-panel" style="display:none;">
    <form action="/rgz/logout" method="get" style="display:inline;">
        <button>Выйти</button>
    </form>

    <form action="/rgz/delete-account" method="post" style="display:inline;">
        <button onclick="return confirm('Удалить аккаунт и все брони?')">Удалить аккаунт</button>
    </form>
</div>

<hr>

<p>Всего ячеек: <span id="total"></span></p>
<p>Занято: <span id="occupied"></span></p>
<p>Свободно: <span id="free"></span></p>
<div id="user-limit-info">
    <p>Ваши брони: <span id="mycount"></span> / 5</p>
</div>

<div id="locker-grid"></div>

{% endblock %}
